rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // Helper SuperAdmin
    function isSuperAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin';
    }

    // Helper: Vérifier si l'utilisateur est un admin client
    function isClientAdmin(clientId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/clients/$(clientId)) &&
             get(/databases/$(database)/documents/clients/$(clientId)).data.adminUid == request.auth.uid;
    }

    // Helper: Vérifier si l'utilisateur est un employé du client
    function isEmployee(clientId, employeeId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/clients/$(clientId)/employees/$(employeeId)) &&
             get(/databases/$(database)/documents/clients/$(clientId)/employees/$(employeeId)).data.authUid == request.auth.uid;
    }

    // Jobs: lisibles publiquement si status='published'
    match /jobs/{jobId} {
      allow read: if resource.data.status == 'published' || request.auth != null;
      allow write: if isSuperAdmin();
    }

    // Applications: création si authentifié (y compris anonyme)
    match /applications/{appId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isSuperAdmin();
    }

    // Mail (Extension Email): création si authentifié
    match /mail/{docId} {
      allow create: if request.auth != null;
      allow read: if isSuperAdmin();
    }

    // Users
    match /users/{userId} {
      allow read, write: if request.auth != null;
    }

    // Blog Posts: lisibles publiquement, écriture par super admin
    match /blogPosts/{postId} {
      allow read: if true; // Public read
      allow write: if isSuperAdmin();
    }

    // Clients et sous-collections
    match /clients/{clientId} {
      // Lecture: si authentifié ET (super admin OU admin du client)
      allow read: if request.auth != null && (isSuperAdmin() || isClientAdmin(clientId));
      // Écriture: si authentifié ET (super admin OU admin du client)
      allow write: if request.auth != null && (isSuperAdmin() || isClientAdmin(clientId));

      // Sous-collection: Employees
      match /employees/{employeeId} {
        // Lecture: 
        // - Si authentifié ET (super admin OU admin du client OU l'employé lui-même)
        // - OU si non authentifié (pour permettre la connexion legacy - À AMÉLIORER)
        allow read: if (request.auth != null && (isSuperAdmin() || isClientAdmin(clientId) || isEmployee(clientId, employeeId))) 
                    || request.auth == null; // TEMPORAIRE: Permet la connexion legacy
        
        // Écriture: seulement si authentifié ET (super admin OU admin du client OU l'employé lui-même pour certaines opérations)
        allow create, update: if request.auth != null && (isSuperAdmin() || isClientAdmin(clientId) || 
                    (isEmployee(clientId, employeeId) && 
                     // L'employé peut seulement modifier certains champs
                     (!('adminUid' in request.resource.data) || request.resource.data.adminUid == resource.data.adminUid) &&
                     (!('email' in request.resource.data) || request.resource.data.email == resource.data.email)));
        
        allow delete: if request.auth != null && (isSuperAdmin() || isClientAdmin(clientId));
      }

      // Autres sous-collections (payslips, documents, etc.)
      match /{document=**} {
        allow read, write: if request.auth != null && (isSuperAdmin() || isClientAdmin(clientId));
      }
    }

    // Employés (collection racine - si elle existe)
    match /employees/{employeeId} {
      allow read, write: if request.auth != null;
    }

    // Paramètres système
    match /systemSettings/{document=**} {
      // Lecture: authentifié (pour les calculs de paie)
      allow read: if request.auth != null;
      // Écriture: seulement super admin
      allow write: if isSuperAdmin();
    }

    // Candidates (pour les candidatures)
    match /candidates/{candidateId} {
      allow read, write: if request.auth != null;
    }

    // Autres collections (fallback): auth requise
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

  }

}

